#.......................................................................
# generate some (D,N,logm) samples from the HMD
#.......................................................................

library(tidyverse)
library(HMDHFDplus)

# 1st example ----
# (big national population): raw data from Russian Males 1980-1984
D = readHMDweb('RUS', item='Deaths_5x5', username=un, password=pw) %>% 
      filter(Year==1980, Age < 100) %>% 
      select(L=Age,Deaths=Male)

N = readHMDweb('RUS', item='Exposures_5x5', username=un, password=pw) %>% 
      filter(Year==1980, Age < 100) %>% 
      select(L=Age,Exposure=Male)

RUS = left_join(D,N) %>% 
        mutate(H = c(tail(L,-1),100),.after='L')

# 2nd example ----
# (small national population): raw data from Icelandic females 2002
D = readHMDweb('ISL', item='Deaths_5x1', username=un, password=pw) %>% 
  filter(Year==2002, Age < 100) %>% 
  select(L=Age,Deaths=Female)

N = readHMDweb('ISL', item='Exposures_5x1', username=un, password=pw) %>% 
  filter(Year==2002, Age < 100) %>% 
  select(L=Age,Exposure=Female)

ISL = left_join(D,N) %>% 
       mutate(H = c(tail(L,-1),100),.after='L')
    

# 3rd example ----
# simulated deaths and exposure for both sexes, 
# Little Rock Arkansas in 1990. 
# 
# 1x1 Life table, both sexes, Arkansas 1990, from USMDB
mx = 
c(0.02738, 0.00221, 0.00129, 8e-04, 0.00059, 0.00054, 0.00048, 
  0.00054, 0.00036, 0.00041, 6e-04, 0.00052, 0.00042, 0.00067, 
  0.00088, 0.0011, 0.00115, 0.00146, 0.00149, 0.00152, 0.0016, 
  0.00189, 0.00185, 0.0014, 0.00191, 0.00141, 0.0013, 0.00165, 
  0.00127, 0.00208, 0.0016, 0.00203, 0.0017, 0.00214, 0.00224, 
  0.00231, 0.00267, 0.00234, 0.00346, 0.00316, 0.00295, 0.00293, 
  0.00441, 0.00418, 0.00385, 0.00513, 0.00482, 0.00583, 0.00619, 
  0.00649, 0.00759, 0.00748, 0.0082, 0.00857, 0.01068, 0.00982, 
  0.01031, 0.01091, 0.01479, 0.01511, 0.01504, 0.01751, 0.01961, 
  0.01948, 0.01985, 0.02369, 0.02522, 0.02949, 0.02944, 0.03234, 
  0.0365, 0.03388, 0.0419, 0.0476, 0.04942, 0.05781, 0.04908, 0.06636, 
  0.06914, 0.08174, 0.09346, 0.089, 0.10525, 0.1113, 0.13789, 0.13177, 
  0.16051, 0.16474, 0.16704, 0.17884, 0.19128, 0.20437, 0.21811, 
  0.23249, 0.24751, 0.26314, 0.27937, 0.29618, 0.31351, 0.33135
)

names(mx) = 0:99

# Pop Data from https://arstatedatacenter.youraedi.com/census/censusdata/Census1990/Cities/LittleRock.pdf 

# Under 5 years....................................................     12,741
# 5 to 17 years....................................................     31,012
# 18 to 20 years...................................................      7,374
# 21 to 24 years...................................................     11,076
# 25 to 44 years...................................................     61,002
# 45 to 54 years...................................................     16,878
# 55 to 59 years...................................................      6,753
# 60 to 64 years...................................................      6,888
# 65 to 74 years...................................................     12,190
# 75 to 84 years...................................................      7,384
# 85 years and over................................................      2,497

# crudely interpolate single-year ages
pop=c(12741, 31012, 7374, 11076,61002,16878,6753, 6888, 12190, 7384,2497)
H  = c(5,18,21,25,45,55,60,65,75,85,105)

P = cumsum(c(0,pop))

sp = smooth.spline(x=c(0,H), y=P)

raw_1yr = predict(sp, 0:100)$y %>% diff()   # 1st diffs of spline fit to cumul pop
adj_1yr = raw_1yr - min(raw_1yr) + 1        # make sure that lowest value = 1 person

# simulate deaths by single year of age 0,1,...99
set.seed(6447100)
Dsim = rpois(length(adj_1yr), adj_1yr * (1-exp(-mx)))

# aggregate deaths back into reported population groups

G = list(0:4,5:17,18:20,21:24,25:44,45:54,55:59,60:64,65:74,75:84,85:99)

Dsim_grouped = sapply(G, function(a) sum(Dsim[(0:99) %in% a]))

# construct a LittleRock dataframe
LittleRock = tibble( L=sapply(G,min), H=sapply(G,max),
                     Deaths=Dsim_grouped, Exposure = pop)

# 4th Example ----
# São Borja, RS Brazil females 2009-2011
# from http://topals-mortality.schmert.net/data/big2010.df.csv
# São Borja is munid 4894, municode 431800

SaoBorja = tribble(
~L,~H,~Deaths,~Exposure,
0,1,1,63.7,
1,2,0,57.8,
2,3,0,56.8,
3,4,0,52.8,
4,5,0,54.7,
5,6,0,60,
6,7,0,69.1,
7,8,0,79.5,
8,9,0,75.4,
9,10,0,73,
10,11,0,71.2,
11,12,0,83.4,
12,13,0,90.4,
13,14,0,85.6,
14,15,0,79.6,
15,16,0,86.4,
16,17,0,88.3,
17,18,1,88.4,
18,19,0,84.4,
19,20,0,90.7,
20,21,0,91,
21,22,0,98.4,
22,23,0,101,
23,24,0,102.3,
24,25,0,89.6,
25,26,0,88.2,
26,27,0,86.6,
27,28,0,89.3,
28,29,0,80.4,
29,30,0,76.2,
30,31,0,71.7,
31,32,0,72.5,
32,33,0,74.4,
33,34,0,74.2,
34,35,0,78.7,
35,36,0,81.5,
36,37,0,88.1,
37,38,0,88.6,
38,39,0,87.9,
39,40,0,75.4,
40,41,0,70.8,
41,42,0,74.5,
42,43,0,87.1,
43,44,0,91.5,
44,45,0,81.7,
45,46,0,73.6,
46,47,0,79.6,
47,48,0,83.8,
48,49,0,90.7,
49,50,0,86.2,
50,51,0,86.1,
51,52,1,80.1,
52,53,0,80.8,
53,54,0,81.9,
54,55,1,82.5,
55,56,0,72.9,
56,57,0,80.1,
57,58,1,75.6,
58,59,0,78.5,
59,60,0,67.7,
60,61,0,70,
61,62,0,67.8,
62,63,1,64.2,
63,64,1,54.2,
64,65,0,45.4,
65,66,0,40,
66,67,0,41.8,
67,68,1,46.2,
68,69,1,48.4,
69,70,0,46.3,
70,71,0,40.9,
71,72,3,37.3,
72,73,0,35.8,
73,74,2,34.1,
74,75,0,34.1,
75,76,1,36.9,
76,77,0,35.4,
77,78,1,31.8,
78,79,0,30.1,
79,80,1,30.5,
80,81,0,27.9,
81,82,1,26,
82,83,3,24.7,
83,84,2,23.5,
84,85,0,15.9,
85,86,2,9.1,
86,87,2,4.7,
87,88,0,5.7,
88,89,1,7.2,
89,90,0,6.5,
90,91,0,4.6,
91,92,0,3,
92,93,0,2,
93,94,0,1.9,
94,95,0,1.1,
95,96,0,0.6,
96,97,0,0.4,
97,98,1,1.3,
98,99,0,1,
99,100,1,0.6)


