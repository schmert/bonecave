---
title: "Comparing Period TFR for 2 groups"
author: "Carl Schmertmann"
date: 10 Nov 2019
output: pdf_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

library(tidyverse)

this_year = 1970  # year for US comparisons
```

## TFR for one group

Suppose that there are $A$ possible single-year reproductive ages $a=1\ldots A$ in which individuals may have children. At some of these ages fertility rates may be zero for some groups (for example, for women at $a > 50$).

Suppose also that there are a total of $B$ births in a given year to some group of interest (such as "all women", "all men", "Asian-American men", "residents of Montana" ...).  Call $\pi_x$ the fraction of the $B$ births that happened to group members who were age $x$. That is, births disaggregated by age are 
$$
B_x = B \:\pi_x \quad x=1,2,\ldots,A
$$ 
If there were $N_x$ group members at age $x$ at mid-year, then period $TFR$ for this group is

\begin{equation}
\label{eq:mainTFR}
TFR = \sum_x \frac{B_x}{N_x} = B \: \sum_x \pi_x \left(\frac{1}{N_x}\right) = B \: E_{\pi} \left( N^{-1}_x\right) 
\end{equation}

where the expectation in (\ref{eq:mainTFR}) is taken over the observed distribution of parents' ages for this year's births. 


## Comparing TFR for 2 groups

If there are two groups then the ratio of their period $TFR$s is

\begin{equation}
\label{eq:TFRratio}
\frac{TFR_1}{TFR_2} = 
\frac{B_1 \: \cdot \: E_{\pi_1} \left(  N^{-1}_{1x}\right)} 
     {B_2 \: \cdot \: E_{\pi_2} \left(  N^{-1}_{2x} \right)}
\end{equation}

In some cases (for example when the groups are "women" and "men") the total births are the same for both groups. For those cases:
\begin{equation}
\label{eq:TFRratiosameB}
\frac{TFR_1}{TFR_2} = \frac{E_{\pi_1} \left( N^{-1}_{1x}\right)} 
                           {E_{\pi_2} \left(  N^{-1}_{2x} \right)}
\end{equation}

Using the results derived in the Appendix below, the ratio in (\ref{eq:TFRratiosameB}) can be approximated well by

$$
\frac{TFR_1}{TFR_2} \approx  
               \frac{N_{2,{m_2}}} 
                    {N_{1,{m_1}}}  
$$
where $m_1$ and $m_2$ are the mean ages of parents in the two groups for this year's observed births. 


# Example: US TFRs in `r this_year`

Start by loading ASFR and population data for `r this_year`. Calculate male and female $TFR$s.

USA male fertility
from Dudel, C. and S. KlÃ¼sener. Male fertility data for high-income 
countries [unpublished data]. Submitted to the HFC by C. Dudel # on 15.05.2019.
 
downloaded from Human Fertility Collection 2 Nov 2019
https://www.fertilitydata.org/data/RAW_DATA/m_USA_51.zip


```{r}

# Male rates from HFC, as described above
asfr_male = read.table(file='m_ASFR_USA.txt', header=TRUE) %>%
              filter(Year== as.character(this_year)) %>%
              pull(ASFR)

# male data pulled is for ages 15-59. Add zero rates for 12-14
asfr_male = c( rep(0,3), asfr_male)
TFR_male  = sum(asfr_male)

# Female rates from HFD
asfr_female = read.table(file='USAasfrTR.txt', skip=2, header=TRUE) %>%
       mutate(Age = 11 + as.numeric(Age)) %>%
       group_by(Year,Age) %>%
       summarize(ASFR = mean(ASFR)) %>%
       filter(Year==as.character(this_year)) %>%
       pull(ASFR)

# female data pulled is for ages 12-54. Add zero rates for 56-59
asfr_female = c( asfr_female, rep(0,4))
TFR_female  = sum(asfr_female)
```

For the US in `r this_year`, female TFR was **`r round(TFR_female,2)`** and male TFR was  **`r round(TFR_male,2)`**.

Now illustrate `r this_year` fertility rates, births, and populations, by age and sex. 

```{r}
tmp = expand.grid(age=12:59, sex=c('male','female')) %>%
        add_column( asfr=c(asfr_male,asfr_female))

ggplot(data=tmp) +
  aes(x=age, y=asfr, color=sex) +
  geom_line(lwd=1.5) +
  scale_color_manual(values=c('blue','red')) +
  labs(title=paste('US Age-Specific Fertility Rates',this_year),
       subtitle=paste('Female TFR=',round(TFR_female,2),
                      '  Male TFR=',  round(TFR_male,2))) +
  theme_bw()

   


# US populations

pop = read.table('Population.txt',skip=2, header=TRUE) %>%
        filter(Year==as.character(this_year), Age %in% 12:59) %>%
        select(Age,Female,Male)

B_male     = pop$Male   * asfr_male
B_female   = pop$Female * asfr_female

# these are slightly different. Use the avg to calculate the period total
B = mean(sum(B_male), sum(B_female))

m_male   = weighted.mean( 12:59+.50, B_male)
m_female = weighted.mean( 12:59+.50, B_female)

msq_male   = weighted.mean( (12:59+.50)^2, B_male)
msq_female = weighted.mean( (12:59+.50)^2, B_female)

v_male   = msq_male   - m_male^2
v_female = msq_female - m_female^2

## function to approximate the pop at the mean age of births
Nm_male   = approx(x=12:59+.50, y=pop$Male,   xout= m_male)$y
Nm_female = approx(x=12:59+.50, y=pop$Female, xout= m_female)$y


tmp = expand.grid(age=12:59, sex=c('male','female')) %>%
        add_column( births=c(B_male,B_female))

ggplot(data=tmp) +
  aes(x=age, y=births, color=sex) +
  geom_line(lwd=1.5) +
  geom_vline(xintercept = c(m_female,m_male), color=c('red','blue'),
             lwd=1.5,lty='dotted') +
  scale_color_manual(values=c('blue','red')) +
  labs(title=paste('US Age-Specific Births',this_year),
       subtitle=paste('Mother\'s Mean Age =',round(m_female,2),
                      'Father\'s Mean Age =',round(m_male,2))) +
  theme_bw()

## population
tmp = expand.grid(age=12:59, sex=c('male','female')) %>%
        add_column( pop=c(pop$Male,pop$Female))

ggplot(data=tmp) +
  aes(x=age, y=pop, color=sex) +
  geom_line(lwd=1.5) +
  geom_vline(xintercept = c(m_female,m_male), color=c('red','blue'),
             lwd=1.5,lty='dotted') +
  scale_color_manual(values=c('blue','red')) +
  labs(title=paste('US Age-Specific Populations',this_year)) +
  theme_bw()

```

Now we will check the approximations based on

* mean parental ages for `r this_year` births:  **`r round(m_female,2)` ** for females and **`r round(m_male,2)` ** for males 
* variance of parental ages for `r this_year` births:  **`r round(v_female,2)` ** for females and **`r round(v_male,2)` ** for males 
* `r this_year` populations at mean ages: **`r round(Nm_female)` ** for females and **`r round(Nm_male)` ** for males 

```{r}

TFR_female
B/Nm_female

TFR_male
B/Nm_male

```

Thus WORKING HERE...

## Appendix: Approximation

We can approximate the $TFR$s in (\ref{eq:mainTFR}) by considering a Taylor series approximation for $N^{-1}_x$. For the purposes of this derivation, temporarily ignore the discrete nature of ages in observed data, and momentarily consider $N_x$ as a continuous function of exact age $x$. 

Define the (period) mean age of parents in our group as $m$. A discrete approximation to $m$ is  $\sum_x \pi_x \,(x+\tfrac{1}{2})$. The second-order Taylor approximation to the $N^{-1}_x$ is 
$$
N^{-1}_x \approx N^{-1}_m + (x-m) \left[ -N^{-2}_m N'_m \right]
+ \tfrac{1}{2} (x-m)^2\left[ 2N^{-3}_m N'_m - N^{-2}_m N''_m\right]
$$
Thus the expectation in (\ref{eq:mainTFR}) is 
$$
E(N^{-1}_x) \approx N^{-1}_m  
+ \tfrac{\sigma^2_x}{2} \left[ 2N^{-3}_m N'_m - N^{-2}_m N''_m\right]
$$
where $\sigma^2_x$ is the observed variance of parental ages. Typical values for the variance term are in $[25,50]$, so when exposure $N$ is measured in thousands or millions, the second-order term is extremely small relative to the first-order term. 

This leads to a very simple approximation for $TFR$ that is fairly robust:
$$
TFR \; \approx \; \frac{B}{N_m} = \frac{\text{total annual births}}{\text{mid-year population at mean parental age}}
$$
